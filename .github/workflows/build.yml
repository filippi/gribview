name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            patchelf \
            libeccodes0 \
            libsdl2-2.0-0 \
            libglew2.2 \
            libgl1-mesa-dev \
            libglu1-mesa-dev

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: gribview
          condarc: |
            channels:
              - conda-forge
          create-args: >-
            cmake
            ninja
            eccodes
            glew
            sdl2
          init-shell: bash
          cache-environment: true

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Prepare artifact folder
        run: |
          rm -rf artifacts/${{ runner.os }}
          mkdir -p artifacts/${{ runner.os }}

      - name: Install
        run: cmake --install build --config Release --prefix "${{ github.workspace }}/artifacts/${{ runner.os }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gribview-${{ runner.os }}
          path: artifacts/${{ runner.os }}

  package:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    name: Release packages (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            patchelf \
            libeccodes0 \
            libsdl2-2.0-0 \
            libglew2.2 \
            libgl1-mesa-dev \
            libglu1-mesa-dev

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: gribview
          condarc: |
            channels:
              - conda-forge
          create-args: >-
            cmake
            ninja
            eccodes
            glew
            sdl2
          init-shell: bash
          cache-environment: true

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Package Homebrew source archive
        if: runner.os == 'Linux'
        env:
          REF_VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${REF_VERSION#v}" ./tools/package_homebrew.sh

      - name: Create installable archives
        run: |
          mkdir -p dist
          cmake -E chdir build cpack -B "${{ github.workspace }}/dist"

      - name: Bundle portable Linux tar (with deps)
        if: runner.os == 'Linux'
        env:
          REF_VERSION: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${REF_VERSION#v}"
          if [ -z "$VERSION" ] || [[ "$VERSION" == refs/* ]]; then
            VERSION=$(grep -Po 'project\\(gribview VERSION \\K[0-9.]+' CMakeLists.txt | head -1)
          fi
          INSTALL_DIR="${GITHUB_WORKSPACE}/dist/linux-portable"
          cmake --install build --config Release --prefix "$INSTALL_DIR"
          mkdir -p "$INSTALL_DIR/lib"
          ldd "$INSTALL_DIR/bin/gribview" | awk '{print $(NF-1)}' | grep -E '^/' | while read -r lib; do
            case "$lib" in
              /lib/*|/usr/lib/*) continue ;;
            esac
            cp -n "$lib" "$INSTALL_DIR/lib/" 2>/dev/null || true
          done
          patchelf --set-rpath '$ORIGIN/../lib' "$INSTALL_DIR/bin/gribview"
          tar -C "${GITHUB_WORKSPACE}/dist" -czf "${GITHUB_WORKSPACE}/dist/gribview-${VERSION}-Linux-portable.tar.gz" "$(basename "$INSTALL_DIR")"

      - name: Bundle Windows zip with DLLs
        if: runner.os == 'Windows'
        env:
          REF_VERSION: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          VERSION="${REF_VERSION#v}"
          if [ -z "$VERSION" ] || [[ "$VERSION" == refs/* ]]; then
            VERSION=$(grep -Po 'project\\(gribview VERSION \\K[0-9.]+' CMakeLists.txt | head -1)
          fi
          PREFIX="$(cygpath -u "${GITHUB_WORKSPACE}")/dist/windows"
          cmake --install build --config Release --prefix "$PREFIX"
          ENV_ROOT="$MAMBA_ROOT_PREFIX/envs/gribview"
          mkdir -p "$PREFIX/bin"
          for dir in "$ENV_ROOT/Library/bin" "$ENV_ROOT/bin"; do
            if [ -d "$dir" ]; then
              cp -n "$dir"/*.dll "$PREFIX/bin/" 2>/dev/null || true
            fi
          done
          for dir in "$ENV_ROOT/Library/share/eccodes" "$ENV_ROOT/share/eccodes"; do
            if [ -d "$dir/definitions" ]; then
              echo "Copying ecCodes definitions/samples from $dir"
              mkdir -p "$PREFIX/Resources/eccodes"
              cp -a "$dir/definitions" "$PREFIX/Resources/eccodes/" || true
              cp -a "$dir/samples" "$PREFIX/Resources/eccodes/" || true
              break
            fi
          done
          rm -f "${GITHUB_WORKSPACE}/dist/gribview-${VERSION}-Windows-AMD64.zip"
          7z a "${GITHUB_WORKSPACE}/dist/gribview-${VERSION}-Windows-AMD64.zip" "$PREFIX"

      - name: List packages
        run: ls -R dist

      - name: Upload release packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ runner.os }}
          path: dist/*

  release:
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_artifacts

      - name: Display collected artifacts
        run: ls -R release_artifacts

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release_artifacts/**/*.tar.gz
            release_artifacts/**/*.zip
            release_artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
